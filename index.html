<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatic Publisher</title>
    <style>
        /* Stili di base per migliorare l'aspetto */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #pages {
            margin-top: 20px;
        }
        .page-item {
            margin-bottom: 15px;
        }
        .page-item label {
            font-weight: bold;
        }
        .page-item input[type="text"] {
            margin-top: 5px;
            padding: 5px;
            width: 300px;
        }
        #message, #imageUrl {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
        #publishButton {
            padding: 10px 20px;
            font-size: 16px;
        }
        #profilePic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
        }
    </style>
    <!-- Includi la libreria CryptoJS -->
    <script src="https://crypto-js.googlecode.com/svn/tags/3.1.9-1/build/rollups/hmac-sha256.js"></script>
</head>
<body>
    <h1>Automatic Publisher</h1>

    <!-- Pulsante per il login con Facebook -->
    <button onclick="facebookLogin()">Login con Facebook</button>

    <!-- Div per mostrare il messaggio di benvenuto -->
    <div id="welcomeMessage"></div>

    <!-- Div per visualizzare le informazioni del profilo -->
    <div id="profileInfo" style="display:none;">
        <h2>Informazioni del Profilo</h2>
        <img id="profilePic" src="" alt="Foto del Profilo">
        <p id="profileName"></p>
        <p id="profileEmail"></p>
    </div>

    <!-- Campi per inserire il messaggio e l'URL dell'immagine -->
    <div id="postContent" style="display:none;">
        <h2>Contenuto del Post</h2>
        <textarea id="message" rows="4" placeholder="Inserisci il messaggio da pubblicare"></textarea>
        <input type="text" id="imageUrl" placeholder="Inserisci l'URL dell'immagine da pubblicare">
    </div>

    <!-- Div per visualizzare le pagine dell'utente -->
    <div id="pages"></div>

    <!-- SDK di Facebook -->
    <div id="fb-root"></div>
    <script>
        // Inizializzazione dell'SDK di Facebook
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '2050475908800227', // Sostituisci con il tuo App ID
                cookie     : true,
                xfbml      : true,
                version    : 'v17.0'
            });

            FB.AppEvents.logPageView();   
        };

        // Caricamento asincrono dell'SDK
        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/it_IT/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));

        // Funzione per calcolare appsecret_proof usando HMAC-SHA256
        function getAppSecretProof(accessToken, appSecret) {
            var hash = CryptoJS.HmacSHA256(accessToken, appSecret);
            return hash.toString(CryptoJS.enc.Hex);
        }

        // Funzione per il login con Facebook
        function facebookLogin() {
            FB.login(function(response) {
                if (response.authResponse) {
                    console.log('Benvenuto! Recupero le tue informazioni.... ');
                    // Nascondi il pulsante di login
                    document.querySelector('button').style.display = 'none';

                    // Ottieni le informazioni del profilo
                    FB.api('/me', {fields: 'id,name,email,picture.width(200).height(200)'}, function(response) {
                        console.log('Informazioni del profilo: ', response);
                        document.getElementById('profileInfo').style.display = 'block';
                        document.getElementById('profilePic').src = response.picture.data.url;
                        document.getElementById('profileName').innerText = 'Nome: ' + response.name;
                        document.getElementById('profileEmail').innerText = 'Email: ' + response.email;
                    });

                    // Mostra il contenuto del post
                    document.getElementById('postContent').style.display = 'block';

                    // Recupera le pagine gestite dall'utente
                    afterLogin();
                } else {
                    console.log('Login non riuscito.');
                }
            }, {scope: 'public_profile,email,user_photos,user_videos,user_posts'});
        }

        // Funzione chiamata dopo il login per recuperare le pagine
        function afterLogin() {
            var appSecret = '21fb22b44220ca5df335f8c1b3b4baf8'; // Sostituisci con il tuo App Secret

            FB.api('/me/accounts', { 
                access_token: FB.getAuthResponse().accessToken,
                appsecret_proof: getAppSecretProof(FB.getAuthResponse().accessToken, appSecret)
            }, function(response) {
                if (response && !response.error) {
                    console.log('Pagine gestite:', response.data);
                    // Mostra le pagine all'utente per selezionarle
                    displayPages(response.data);
                    // Mostra il contenuto del post
                    document.getElementById('postContent').style.display = 'block';
                } else {
                    console.error('Errore nel recupero delle pagine:', response.error);
                }
            });
        }

        // Funzione per visualizzare le pagine e permettere la selezione
        function displayPages(pages) {
            var pagesContainer = document.getElementById('pages');
            pagesContainer.innerHTML = '<h2>Seleziona le Pagine</h2>';

            pages.forEach(function(page) {
                var pageItem = document.createElement('div');
                pageItem.className = 'page-item';

                var checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = page.id;
                checkbox.name = 'pages';
                checkbox.value = page.access_token;

                var label = document.createElement('label');
                label.htmlFor = page.id;
                label.appendChild(document.createTextNode(' ' + page.name));

                var utmInput = document.createElement('input');
                utmInput.type = 'text';
                utmInput.placeholder = 'Inserisci UTM per questa pagina';
                utmInput.id = 'utm_' + page.id;

                pageItem.appendChild(checkbox);
                pageItem.appendChild(label);
                pageItem.appendChild(document.createElement('br'));
                pageItem.appendChild(utmInput);

                pagesContainer.appendChild(pageItem);
            });

            // Aggiungi un pulsante per pubblicare
            var publishButton = document.createElement('button');
            publishButton.id = 'publishButton';
            publishButton.innerText = 'Pubblica su Pagine Selezionate';
            publishButton.onclick = publishToPages;
            pagesContainer.appendChild(publishButton);
        }

        // Funzione per pubblicare su pagine selezionate
        function publishToPages() {
            var message = document.getElementById('message').value;
            var imageUrl = document.getElementById('imageUrl').value;
            var selectedPages = document.querySelectorAll('input[name="pages"]:checked');

            selectedPages.forEach(function(page) {
                var pageAccessToken = page.value;
                var pageId = page.id;
                var utm = document.getElementById('utm_' + pageId).value;

                var postData = {
                    message: message + ' ' + utm,
                    access_token: pageAccessToken
                };

                if (imageUrl) {
                    postData.url = imageUrl;
                }

                FB.api(`/${pageId}/photos`, 'POST', postData, function(response) {
                    if (response && !response.error) {
                        console.log('Post pubblicato con successo su ' + pageId, response);

                        // Aggiungi il primo commento con il link e l'UTM
                        var link = 'https://tuo-link.com/?utm_source=' + encodeURIComponent(utm);

                        FB.api(
                            '/' + response.post_id + '/comments',
                            'POST',
                            {
                                message: link,
                                access_token: pageAccessToken
                            },
                            function(commentResponse) {
                                if (commentResponse && !commentResponse.error) {
                                    console.log('Commento aggiunto al post ID: ' + response.post_id);
                                } else {
                                    console.error('Errore nell\'aggiunta del commento:', commentResponse.error);
                                }
                            }
                        );

                    } else {
                        console.error('Errore nella pubblicazione del post:', response.error);
                    }
                });
            });

            alert('Pubblicazione completata sulle pagine selezionate.');
        }
    </script>
        <footer>
            <p>&copy; 2023 The Social Traffic. Tutti i diritti riservati.</p>
            <p><a href="https://gdonnoh.github.io/Informativa-sulla-privacy/">Informativa sulla Privacy</a></p>
        </footer>
</body>
</html>
